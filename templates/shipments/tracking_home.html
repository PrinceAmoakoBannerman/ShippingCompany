{% extends 'base.html' %}

{% block title %}Track Your Shipment - ShipTrack Pro{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        <h1 class="hero-title">Track Your Shipment</h1>
        <p class="hero-subtitle">Enter your BL Number, Container Number, or Chassis Number to get real-time updates</p>
        
        <!-- Tracking Form -->
        <div class="tracking-form">
            <form id="trackingForm" method="post" class="d-flex w-100 gap-2">{% csrf_token %}
                <input 
                    type="text" 
                    id="trackingNumber" 
                    class="form-control tracking-input flex-grow-1" 
                    placeholder="Enter BL Number, Container Number, or Chassis Number"
                    required
                >
                <button type="submit" class="btn btn-primary tracking-btn">
                    <i class="fas fa-search"></i> Track
                </button>
            </form>
        </div>

        <!-- Loading Spinner -->
        <div class="loading-spinner" id="loadingSpinner"></div>

        <!-- Progress Bar -->
        <div class="progress mt-3" id="progressBarContainer" style="display: none;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" 
                 style="width: 0%;" 
                 id="progressBar">
                0%
            </div>
        </div>

        <!-- Results Container -->
        <div id="resultsContainer" class="mt-5" style="display: none;"></div>
    </div>
</section>

<!-- Features Section -->
<section class="py-5">
    <div class="container">
        <div class="row">
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <div class="feature-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <h5 class="card-title">Real-Time Tracking</h5>
                        <p class="card-text">Get up-to-date information about your shipment's location and status.</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <div class="feature-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <h5 class="card-title">ETA Updates</h5>
                        <p class="card-text">Know exactly when your shipment will arrive at its destination.</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <div class="feature-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <h5 class="card-title">Secure Platform</h5>
                        <p class="card-text">Your shipment data is protected with enterprise-grade security.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Recent Activity Section -->
{% if recent_arrivals %}
<section class="py-5 bg-light">
    <div class="container">
        <h2 class="text-center mb-5">Recent Arrivals</h2>
        <div class="row">
            {% for shipment in recent_arrivals %}
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title"><i class="fas fa-cube"></i> {{ shipment.bl_number }}</h6>
                        <p class="card-text">
                            <small class="text-muted">
                                Container: {{ shipment.container_no }}<br>
                                Delivered: {{ shipment.gate_out_date|date:"M d, Y" }}
                            </small>
                        </p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- Carriers Section -->
<section class="py-5 bg-light">
    <div class="container text-center">
        <h2 class="mb-4">Our Trusted Carriers</h2>
        <div class="row justify-content-center">
            <div class="col-md-2 col-4 mb-3">
                <img src="/static/images/carrier1.png" alt="Carrier 1" class="img-fluid">
            </div>
            <div class="col-md-2 col-4 mb-3">
                <img src="/static/images/carrier2.png" alt="Carrier 2" class="img-fluid">
            </div>
            <div class="col-md-2 col-4 mb-3">
                <img src="/static/images/carrier3.png" alt="Carrier 3" class="img-fluid">
            </div>
            <div class="col-md-2 col-4 mb-3">
                <img src="/static/images/carrier4.png" alt="Carrier 4" class="img-fluid">
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const trackingForm = document.getElementById('trackingForm');
    const trackingNumber = document.getElementById('trackingNumber');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const resultsContainer = document.getElementById('resultsContainer');
    const progressBarContainer = document.getElementById('progressBarContainer');
    const progressBar = document.getElementById('progressBar');

    trackingForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const trackingNum = trackingNumber.value.trim();
        if (!trackingNum) {
            showAlert('Please enter a tracking number', 'warning');
            return;
        }

        // Show loading spinner
        loadingSpinner.style.display = 'block';
        resultsContainer.style.display = 'none';
        progressBarContainer.style.display = 'block';
        progressBar.style.width = '0%';
        progressBar.innerText = '0%';

        // Make AJAX request
        fetch('{% url "shipments:track_shipment" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                tracking_number: trackingNum
            })
        })
        .then(response => response.json())
        .then(data => {
            loadingSpinner.style.display = 'none';
            progressBarContainer.style.display = 'none';
            
            if (data.success) {
                displayShipmentDetails(data.shipment);
            } else {
                showAlert(data.message, 'danger');
            }
        })
        .catch(error => {
            loadingSpinner.style.display = 'none';
            progressBarContainer.style.display = 'none';
            showAlert('An error occurred. Please try again later.', 'danger');
            console.error('Error:', error);
        });
    });

    function displayShipmentDetails(shipment) {
        const statusColor = shipment.status_color;
        const statusText = shipment.gate_out_date !== 'Not yet delivered' ? 'Delivered' : 
                          (shipment.is_overdue ? `Overdue (${shipment.days_overdue} days)` : 'In Transit');

        const html = `
            <div class="card">
                <div class="card-header bg-${statusColor} text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-cube"></i> Shipment Details
                        <span class="float-end">
                            <span class="badge bg-light text-dark">${statusText}</span>
                        </span>
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="shipment-detail-card">
                                <div class="detail-label">BL Number</div>
                                <div class="detail-value"><strong>${shipment.bl_number}</strong></div>
                            </div>
                            
                            <div class="shipment-detail-card">
                                <div class="detail-label">Container Number</div>
                                <div class="detail-value"><strong>${shipment.container_no}</strong></div>
                            </div>

                            ${shipment.chassis_no !== 'N/A' ? `
                            <div class="shipment-detail-card">
                                <div class="detail-label">Chassis Number</div>
                                <div class="detail-value"><strong>${shipment.chassis_no}</strong></div>
                            </div>
                            ` : ''}

                            <div class="shipment-detail-card">
                                <div class="detail-label">Shipping Line</div>
                                <div class="detail-value">${shipment.shipping_line}</div>
                            </div>

                            <div class="shipment-detail-card">
                                <div class="detail-label">Consignee</div>
                                <div class="detail-value">${shipment.consignee}</div>
                            </div>

                            <div class="shipment-detail-card">
                                <div class="detail-label">Shipper</div>
                                <div class="detail-value">${shipment.shipper}</div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="shipment-detail-card">
                                <div class="detail-label">Expected Arrival (ETA)</div>
                                <div class="detail-value">
                                    <i class="fas fa-calendar"></i> ${shipment.eta}
                                </div>
                            </div>

                            <div class="shipment-detail-card">
                                <div class="detail-label">Gate Out Date</div>
                                <div class="detail-value">
                                    <i class="fas fa-calendar-check"></i> ${shipment.gate_out_date}
                                </div>
                            </div>

                            <div class="shipment-detail-card">
                                <div class="detail-label">Duty Status</div>
                                <div class="detail-value">
                                    <span class="status-indicator ${shipment.duty_status === 'Paid' ? 'status-paid' : 'status-not-paid'}">
                                        <i class="fas ${shipment.duty_status === 'Paid' ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                                        ${shipment.duty_status}
                                    </span>
                                </div>
                            </div>

                            <div class="shipment-detail-card">
                                <div class="detail-label">Freight Status</div>
                                <div class="detail-value">
                                    <span class="status-indicator ${getFreightStatusClass(shipment.freight_status)}">
                                        <i class="fas ${getFreightStatusIcon(shipment.freight_status)}"></i>
                                        ${shipment.freight_status}
                                    </span>
                                </div>
                            </div>

                            <div class="shipment-detail-card">
                                <div class="detail-label">Assigned Agent</div>
                                <div class="detail-value">
                                    <i class="fas fa-user"></i> ${shipment.agent_assigned}
                                </div>
                            </div>

                            <div class="shipment-detail-card">
                                <div class="detail-label">Supervisor Status</div>
                                <div class="detail-value">${shipment.supervisor_status}</div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="shipment-detail-card">
                                <div class="detail-label">Description</div>
                                <div class="detail-value">${shipment.description}</div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="shipment-detail-card">
                                <div class="detail-label">Free Days</div>
                                <div class="detail-value"><i class="fas fa-clock"></i> ${shipment.free_days} days</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="shipment-detail-card">
                                <div class="detail-label">Demurrage Days</div>
                                <div class="detail-value">
                                    <i class="fas fa-exclamation-triangle ${shipment.demurrage_days > 0 ? 'text-warning' : ''}"></i> 
                                    ${shipment.demurrage_days} days
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        resultsContainer.innerHTML = html;
        resultsContainer.style.display = 'block';

        // Smooth scroll to results
        resultsContainer.scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
        });
    }

    function getFreightStatusClass(status) {
        switch(status.toLowerCase()) {
            case 'paid': return 'status-paid';
            case 'not paid': return 'status-not-paid';
            case 'pending': return 'status-pending';
            default: return 'status-pending';
        }
    }

    function getFreightStatusIcon(status) {
        switch(status.toLowerCase()) {
            case 'paid': return 'fa-check-circle';
            case 'not paid': return 'fa-times-circle';
            case 'pending': return 'fa-clock';
            default: return 'fa-clock';
        }
    }

    function showAlert(message, type) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                <i class="fas fa-${type === 'danger' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-circle' : 'info-circle'}"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        resultsContainer.innerHTML = alertHtml;
        resultsContainer.style.display = 'block';
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    console.log('Cookies:', document.cookie); // Debugging cookies

    const csrftoken = getCookie('csrftoken');
    if (!csrftoken) {
        console.error('CSRF token not found. Ensure the CSRF middleware is active.');
    } else {
        console.log('CSRF Token:', csrftoken); // Debugging CSRF token
    }
});
</script>
{% endblock %}